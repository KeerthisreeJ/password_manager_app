# =============================================================================
# Release Pipeline â€” password_manager_app (Flutter)
# =============================================================================
# WHAT THIS DOES:
#   Triggered when you create a version tag (e.g., v1.0.0)
#   1. Runs full CI (analyze + test)
#   2. Builds a release APK
#   3. Creates a GitHub Release with the APK attached
#
# HOW TO TRIGGER:
#   git tag v1.0.0
#   git push origin v1.0.0
# =============================================================================

name: Flutter Release

# â”€â”€ TRIGGER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Only runs when you push a version tag like v1.0.0, v2.1.3, etc.
on:
  push:
    tags:
      - 'v*'

jobs:

  # â”€â”€ CI CHECKS (same as ci.yml) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ci:
    name: "âœ… CI Checks"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Analyze
        run: flutter analyze --no-fatal-infos

      - name: Test
        run: flutter test

  # â”€â”€ BUILD & RELEASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  release:
    name: "ðŸš€ Build & Release APK"
    runs-on: ubuntu-latest
    needs: ci               # Only release if CI passes
    permissions:
      contents: write       # Needed to create GitHub Releases
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install dependencies
        run: flutter pub get

      # Build release APK (using debug signing for now)
      - name: Build Release APK
        run: flutter build apk --release

      # Create a GitHub Release page and attach the APK file
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: build/app/outputs/flutter-apk/app-release.apk
          generate_release_notes: true    # Auto-generate changelog from commits
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
